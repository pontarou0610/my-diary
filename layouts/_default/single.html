{{ define "main" }}
<article class="post">
  <header class="post-hero">
    {{- with .Params.tags }}
    <div class="post-hero__tags">
      {{- range . }}
      <span class="tag-badge">#{{ . }}</span>
      {{- end }}
    </div>
    {{- end }}

    <h1 class="post-hero__title">{{ .Title }}</h1>

    <div class="post-hero__meta">
      <time datetime="{{ .Date.Format " 2006-01-02T15:04:05Z07:00" }}">
        {{ .Date.Format "2006.01.02" }}
      </time>
      {{- if .Params.categories }}
      <span>in {{ index .Params.categories 0 }}</span>
      {{- end }}
    </div>
  </header>

  {{- $hero := "" }}
  {{- with .Params.cover.image }}
  {{- $clean := replaceRE "^/" "" . }}
  {{- if fileExists (printf "static/%s" $clean) }}
  {{- $hero = $clean | relURL }}
  {{- else if site.Params.defaultOgImage }}
  {{- $hero = site.Params.defaultOgImage | relURL }}
  {{- end }}
  {{- end }}
  {{- if and (eq $hero "") site.Params.defaultOgImage }}
  {{- $hero = site.Params.defaultOgImage | relURL }}
  {{- end }}
  {{- if $hero }}
  <img src="{{ $hero }}" alt="{{ $.Params.cover.alt }}" loading="lazy">
  {{- end }}

  {{- if (.Param "ShowToc") }}
  {{ partial "toc.html" . }}
  {{- end }}

  <div class="post-content">
    {{ .Content }}
  </div>

  <footer class="share-buttons">
    {{- if (and site.Params.ShowShareButtons (ne .Params.disableShare true)) }}
    {{ partial "share_icons.html" . }}
    {{- end }}
  </footer>

  {{/* 前後の記事リンク */}}
  <section class="post-nav">
    <h2>前後の記事</h2>
    <ul>
      {{- with .PrevInSection }}
      <li>← <a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
      {{- end }}
      {{- with .NextInSection }}
      <li>→ <a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
      {{- end }}
    </ul>
  </section>

  {{/* 関連記事（タグが重なるものから最大3件） */}}
  {{- $related := where (where site.RegularPages "Permalink" "ne" .Permalink) "Params.tags" "intersect" .Params.tags }}
  {{- if gt (len $related) 0 }}
  <section class="post-related">
    <h2>関連記事</h2>
    <ul>
      {{- range first 3 $related }}
      <li><a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
      {{- end }}
    </ul>
  </section>
  {{- end }}

  {{/* 人気記事（データがないので最新3件を代替表示） */}}
  {{- $popular := first 3 (where site.RegularPages.ByDate.Reverse "Permalink" "ne" .Permalink) }}
  {{- if gt (len $popular) 0 }}
  <section class="post-popular">
    <h2>人気記事</h2>
    <ul>
      {{- range $popular }}
      <li><a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
      {{- end }}
    </ul>
  </section>
  {{- end }}
</article>
{{ end }}